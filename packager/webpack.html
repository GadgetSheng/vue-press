<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.35">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>学习webpack | BFE.LEARNING</title><meta name="description" content="Just learning <BIG.FRONT.END>">
    <link rel="modulepreload" href="/vue-press/assets/app.8af49527.js"><link rel="modulepreload" href="/vue-press/assets/webpack.html.f9c84fb2.js"><link rel="modulepreload" href="/vue-press/assets/webpack.html.6988905e.js"><link rel="modulepreload" href="/vue-press/assets/plugin-vue_export-helper.21dcd24c.js">
    <link rel="stylesheet" href="/vue-press/assets/style.6ce0d35e.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/vue-press/" class=""><img class="logo" src="/vue-press/images/logo.png" alt="BFE.LEARNING"><span class="site-name can-hide">BFE.LEARNING</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/vue-press/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vue-press/category/" class="" aria-label="Category"><!--[--><!--]--> Category <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/steven7sheng/vue-press" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/vue-press/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vue-press/category/" class="" aria-label="Category"><!--[--><!--]--> Category <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/steven7sheng/vue-press" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/vue-press/guide/" class="sidebar-item sidebar-heading" aria-label="Guide"><!--[--><!--]--> Guide <!--[--><!--]--></a><!----></li><li><a href="/vue-press/category/" class="sidebar-item sidebar-heading" aria-label="Category"><!--[--><!--]--> Category <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/vue-press/category/learn-css.html" class="sidebar-item" aria-label="来学CSS"><!--[--><!--]--> 来学CSS <!--[--><!--]--></a><!----></li><li><a href="/vue-press/category/article-2.html" class="sidebar-item" aria-label="Article 2"><!--[--><!--]--> Article 2 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/vue-press/packager/" class="router-link-active sidebar-item sidebar-heading active" aria-label="packager"><!--[--><!--]--> packager <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/vue-press/packager/webpack.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="学习webpack"><!--[--><!--]--> 学习webpack <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/vue-press/packager/webpack.html#original" class="router-link-active router-link-exact-active sidebar-item" aria-label="Original"><!--[--><!--]--> Original <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/vue-press/packager/webpack.html#concepts" class="router-link-active router-link-exact-active sidebar-item" aria-label="Concepts"><!--[--><!--]--> Concepts <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#entry" class="router-link-active router-link-exact-active sidebar-item" aria-label="Entry"><!--[--><!--]--> Entry <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#output" class="router-link-active router-link-exact-active sidebar-item" aria-label="Output"><!--[--><!--]--> Output <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#plugins" class="router-link-active router-link-exact-active sidebar-item" aria-label="Plugins"><!--[--><!--]--> Plugins <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#mode" class="router-link-active router-link-exact-active sidebar-item" aria-label="Mode"><!--[--><!--]--> Mode <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#browser-compatibility" class="router-link-active router-link-exact-active sidebar-item" aria-label="Browser Compatibility"><!--[--><!--]--> Browser Compatibility <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#scenarios" class="router-link-active router-link-exact-active sidebar-item" aria-label="Scenarios"><!--[--><!--]--> Scenarios <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#multiple-entry-points" class="router-link-active router-link-exact-active sidebar-item" aria-label="Multiple Entry Points"><!--[--><!--]--> Multiple Entry Points <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#webpack内容综述" class="router-link-active router-link-exact-active sidebar-item" aria-label="Webpack内容综述"><!--[--><!--]--> Webpack内容综述 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/vue-press/packager/webpack.html#_01-webpack与构建发展简史" class="router-link-active router-link-exact-active sidebar-item" aria-label="01 webpack与构建发展简史"><!--[--><!--]--> 01 webpack与构建发展简史 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#_02-webpack基础用法" class="router-link-active router-link-exact-active sidebar-item" aria-label="02 webpack基础用法"><!--[--><!--]--> 02 webpack基础用法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#_03-webpack进阶用法" class="router-link-active router-link-exact-active sidebar-item" aria-label="03 webpack进阶用法"><!--[--><!--]--> 03 webpack进阶用法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#_04-编写可维护的webpack构建配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="04 编写可维护的webpack构建配置"><!--[--><!--]--> 04 编写可维护的webpack构建配置 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#_05-webpack构建速度和体积优化策略" class="router-link-active router-link-exact-active sidebar-item" aria-label="05 Webpack构建速度和体积优化策略"><!--[--><!--]--> 05 Webpack构建速度和体积优化策略 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#_06-通过源码掌握webpack打包原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="06 通过源码掌握webpack打包原理"><!--[--><!--]--> 06 通过源码掌握webpack打包原理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#_07-编写loader插件" class="router-link-active router-link-exact-active sidebar-item" aria-label="07 编写Loader插件"><!--[--><!--]--> 07 编写Loader插件 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="学习webpack" tabindex="-1"><a class="header-anchor" href="#学习webpack" aria-hidden="true">#</a> 学习webpack</h1><nav class="table-of-contents"><ul><li><a aria-current="page" href="/vue-press/packager/webpack.html#original" class="router-link-active router-link-exact-active">Original</a><ul><li><a aria-current="page" href="/vue-press/packager/webpack.html#concepts" class="router-link-active router-link-exact-active">Concepts</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#entry" class="router-link-active router-link-exact-active">Entry</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#output" class="router-link-active router-link-exact-active">Output</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#plugins" class="router-link-active router-link-exact-active">Plugins</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#mode" class="router-link-active router-link-exact-active">Mode</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#browser-compatibility" class="router-link-active router-link-exact-active">Browser Compatibility</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#scenarios" class="router-link-active router-link-exact-active">Scenarios</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#multiple-entry-points" class="router-link-active router-link-exact-active">Multiple Entry Points</a></li></ul></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#webpack内容综述" class="router-link-active router-link-exact-active">Webpack内容综述</a><ul><li><a aria-current="page" href="/vue-press/packager/webpack.html#_01-webpack与构建发展简史" class="router-link-active router-link-exact-active">01 webpack与构建发展简史</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#_02-webpack基础用法" class="router-link-active router-link-exact-active">02 webpack基础用法</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#_03-webpack进阶用法" class="router-link-active router-link-exact-active">03 webpack进阶用法</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#_04-编写可维护的webpack构建配置" class="router-link-active router-link-exact-active">04 编写可维护的webpack构建配置</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#_05-webpack构建速度和体积优化策略" class="router-link-active router-link-exact-active">05 Webpack构建速度和体积优化策略</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#_06-通过源码掌握webpack打包原理" class="router-link-active router-link-exact-active">06 通过源码掌握webpack打包原理</a></li><li><a aria-current="page" href="/vue-press/packager/webpack.html#_07-编写loader插件" class="router-link-active router-link-exact-active">07 编写Loader插件</a></li></ul></li></ul></nav><h2 id="original" tabindex="-1"><a class="header-anchor" href="#original" aria-hidden="true">#</a> Original</h2><details class="custom-container details"><summary>官方原文</summary><h3 id="concepts" tabindex="-1"><a class="header-anchor" href="#concepts" aria-hidden="true">#</a> Concepts</h3><p>webpack is a <strong>static</strong> module bundler for modern JavaScript application</p><p>it internally builds a [<code>dependency graph</code>] from one or more entry points and then combines every module your project needs into one or more bundles, which are static assets to serve your content from.</p><p>Core concepts:</p><ul><li>Entry</li><li>Output</li><li>Loaders</li><li>Plugins</li><li>Mode</li><li>Browser Compatiblity</li></ul><p>一期目标问题</p><ul><li>Manually Bundling an Application</li><li>Live Coding a Simple Module Bundler</li><li>Detailed Explaination of a Simple Module Bundler</li></ul><h3 id="entry" tabindex="-1"><a class="header-anchor" href="#entry" aria-hidden="true">#</a> Entry</h3><p>entry point = which module webpack begin building out its internal <strong>dependency graph</strong>. figure out depends on(directly or indirectly).</p><p><code>./src/index.js</code></p><h3 id="output" tabindex="-1"><a class="header-anchor" href="#output" aria-hidden="true">#</a> Output</h3><p>emit the bundles and specific the names of these files. <code>./dist/main.js</code> { path, filename }</p><h3 id="plugins" tabindex="-1"><a class="header-anchor" href="#plugins" aria-hidden="true">#</a> Plugins</h3><p>leveraged to perform a wider range of tasks like bundle optimization , asset management and injection of enviroment variables. <em>extend capabilities</em></p><ul><li>require it</li><li>push to plugins array</li><li>create instance with <code>new</code></li></ul><h3 id="mode" tabindex="-1"><a class="header-anchor" href="#mode" aria-hidden="true">#</a> Mode</h3><p>development,<code>production</code>,none built-in optimization that correspond to each environment.</p><h3 id="browser-compatibility" tabindex="-1"><a class="header-anchor" href="#browser-compatibility" aria-hidden="true">#</a> Browser Compatibility</h3><p>supports all &quot;ES5-compliant&quot; webpack needs Promise for <code>import()</code>,<code>require.ensure()</code>. to support older browser you need to load polyfill.</p><blockquote><p>Webpack 5 runs on Node.js version 10.13.0+</p></blockquote><h3 id="scenarios" tabindex="-1"><a class="header-anchor" href="#scenarios" aria-hidden="true">#</a> Scenarios</h3><ol><li>Seperate App and Vender Entries</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token punctuation">{</span>
        main<span class="token operator">:</span> &#39;xxx&#39;<span class="token punctuation">,</span>
        vendor<span class="token operator">:</span> &#39;yyy&#39;
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
        filename<span class="token operator">:</span> &#39;<span class="token punctuation">[</span>name<span class="token punctuation">]</span>.<span class="token punctuation">[</span>contenthash<span class="token punctuation">]</span>.bundle.js&#39;<span class="token punctuation">,</span> <span class="token comment">// prod</span>
        filename<span class="token operator">:</span> &#39;<span class="token punctuation">[</span>name<span class="token punctuation">]</span>.bundle.js&#39; <span class="token comment">// dev</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>optimization.splitChunks</code> option takes care of seperating vendors and app modules.</p><h3 id="multiple-entry-points" tabindex="-1"><a class="header-anchor" href="#multiple-entry-points" aria-hidden="true">#</a> Multiple Entry Points</h3><p>Output has a unique name. can use substitutions <code>[name]</code></p></details><h2 id="webpack内容综述" tabindex="-1"><a class="header-anchor" href="#webpack内容综述" aria-hidden="true">#</a> Webpack内容综述</h2><div class="custom-container tip"><p class="custom-container-title">章节</p><ul><li>P1-P3 webpack 的基本概念和日常开发的使用技巧</li><li>P4-P5 以工程化的方式组织webpack构建配置，和webpack打包优化</li><li>P6-P7 详细剖析webpack打包原理和插件，以及loader的实现</li><li>P8 从实际web商城项目出发，讲解webpack实际使用</li></ul></div><h3 id="_01-webpack与构建发展简史" tabindex="-1"><a class="header-anchor" href="#_01-webpack与构建发展简史" aria-hidden="true">#</a> 01 webpack与构建发展简史</h3><p>为什么需要构建工具</p><ul><li>转换ES6语法</li><li>转换JSX</li><li>CSS前缀补全/预处理器</li><li>压缩混淆</li><li>图片压缩</li></ul><p>构建演变之路 <code>ant+YUI tool --&gt; grunt --&gt; fis3/gulp --&gt; rollup,webpack,parcel</code></p><p>为什么选择webpack</p><ul><li>社区生态丰富</li><li>配置灵活和插件化扩展</li><li>官方更新迭代速度快</li></ul><p>初识webpack：配置文件名称</p><ul><li>webpack默认配置文件 <code>webpack.config.js</code></li><li>可以通过 webpack --config 指定配置文件</li></ul><p>初识webpack：配置组成</p><ul><li>entry // 打包的入口文件</li><li>output // 打包的输出</li><li>mode // 环境</li><li>module.rules // Loader配置</li><li>module.plugins // 插件配置</li></ul><p><strong>零配置</strong>webpack包含哪些内容</p><ul><li>默认entry为 ./src/index.js</li><li>默认output为 ./dist/main.js</li><li>loader raw-loader</li><li>plugins HtmlwebpackPlugin template:./src/index.html</li></ul><p>环境搭建 Node.js 和 NPM</p><p>安装webpack和 webpack-cli</p><p>webpack初体验</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> path<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">&#39;./src/index.js&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;dist&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;bundle.js&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>---&gt;构建结果</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">doctype</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dist/bundle.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>通过npm script 运行<code>webpack</code></p><p><strong>原理</strong> 模块局部安装会在 node_modules/.bin目录创建软链接</p></blockquote><h3 id="_02-webpack基础用法" tabindex="-1"><a class="header-anchor" href="#_02-webpack基础用法" aria-hidden="true">#</a> 02 webpack基础用法</h3><p>Entry 用来指定webpack的打包入口</p><p>模块依赖图的入口是 entry 对于非代码比如图片、字体依赖也会不断加入到依赖图中</p><p>Entry的用法</p><ul><li>单入口：entry是一个字符串</li><li>多入口：entry是一个对象</li></ul><p>Output用来告诉webpack 如何将编译后的文件输出到磁盘</p><p>Output的用法：单入口配置</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span><span class="token string">&#39;./path/to/my/entry/file.js&#39;</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;bundle.js&#39;</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> __dirname <span class="token operator">+</span> <span class="token string">&#39;/dist&#39;</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Output的用法：多入口配置</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">app</span><span class="token operator">:</span> <span class="token string">&#39;./src/app.js&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">search</span><span class="token operator">:</span> <span class="token string">&#39;./src/search.js&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;[name].js&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> __dirname <span class="token operator">+</span> <span class="token string">&#39;/dist&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>通过占位符确保文件名称的唯一</p></blockquote><ul><li>核心概念之Loaders</li></ul><p>webpack开箱即用只支持js和json两种文件类型，通过Loaders去支持其他文件类型并且把它们转化成有效的模块， 并且可以添加到依赖图中。 本身是一个函数，接受源文件作为参数，返回转换的结果。</p><p>常见的Loaders</p><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>babel-loader</td><td>转换ES6+等JS新特性语法</td></tr><tr><td>css-loader</td><td>支持.css文件的加载和解析</td></tr><tr><td>less-loader,sass-loader</td><td>...</td></tr><tr><td>ts-loader</td><td>将ts转换成css</td></tr><tr><td>file-loader</td><td>进行图片、字体等的打包</td></tr><tr><td>raw-loader</td><td>将文件以字符串的形式导入</td></tr><tr><td>thread-loader</td><td>多进程打包JS和CSS</td></tr></tbody></table><p>Loaders 的用法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> path<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;bundle.js&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">rules</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.txt$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span><span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token string">&#39;raw-loader&#39;</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p><code>test</code> 指定匹配规则,<code>use</code> 指定使用的loader名称</p></blockquote><ul><li>核心概念之Plugins</li></ul><p>插件用于bundle文件的优化，资源管理器和环境变量的注入 作用于整个构建过程</p><p>常见的Plugins有哪些?</p><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>CommonsChunkPlugin</td><td>将chunks相同的模块代码提取成公共js</td></tr><tr><td>CleanWebpackPlugin</td><td>清理构建目录</td></tr><tr><td>ExtractTextWebpackPlugin</td><td>将CSS从bundle文件里提取成一个独立的CSS文件</td></tr><tr><td>CopyWebpackPlugin</td><td>将文件或者文件夹拷贝到构建的输出目录</td></tr><tr><td>HtmlWebpackPlugin</td><td>创建HTML文件去承载输出的bundle</td></tr><tr><td>UglifyjsWebpackPlugin</td><td>压缩JS</td></tr><tr><td>ZipWebpackPlugin</td><td>将打包出的资源生成一个zip包</td></tr></tbody></table><p>Plugins的用法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> path<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;bundle.js&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">template</span><span class="token operator">:</span><span class="token string">&#39;./src/index.html&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>放到plugins的数组里面</p></blockquote><ul><li>核心概念之Mode Mode用来指定当前的构建环境是: production development还是none， 设置mode可以使用webpack内置的函数，默认值是production</li></ul><p>Mode的内置函数功能</p><table><thead><tr><th>选项</th><th>描述</th></tr></thead><tbody><tr><td>development</td><td>设p<wbr>rocess.env.NODE_ENV 的值为 development. 开启NamedChunksPlugin+NameModulesPlugin.</td></tr><tr><td>production</td><td>设p<wbr>rocess.env.NODE_ENV 的值为 production. 开启&quot;一堆Plugin&quot;</td></tr><tr><td>none</td><td>不开启任何优化选项</td></tr></tbody></table><div class="custom-container tip"><p class="custom-container-title">&quot;一堆Plugin&quot;</p><ul><li>FlagDependencyUsagePlugin</li><li>FlagIncludedChunksPlugin</li><li>ModuleConcatentationPlugin</li><li>NoEmitOnErrorsPlugin</li><li>OccurenceOrderPlugin</li><li>SideEffectsFlagPlugin</li><li>TerserPlugin</li></ul></div><p>资源解析: 解析ES6 使用babel-loader babel的配置文件是.babelrc</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">rules</span><span class="token operator">:</span><span class="token punctuation">[</span> <span class="token punctuation">{</span><span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span><span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token string">&#39;babel-loader&#39;</span><span class="token punctuation">}</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>增加ES6的babel preset配置</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;@babel/proposal-class-properties&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>增加ES6 preset配置</p></blockquote><p>资源解析: 解析React JSX</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;@babel/preset-react&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;@babel/proposal-class-properties&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>增加React的 babel-preset 配置</p></blockquote><p>资源解析: 解析CSS</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">rules</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span><span class="token literal-property property">use</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;style-loader&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>css-loader用于加载.css文件，并且转换成commonjs对象 style-loader 将样式通过<code>&lt;style&gt;</code>标签插入到head中</p></blockquote><p>解析Less和SaSS less-loader 用于将less转换成css 解析图片 file-loader 用于处理文件 <code>test: /\.(png|svg|jpg|gif)$/</code> 解析字体 file-loader 也可以用于处理字体 <code>test: /\.(woff|woff2|eot|ttf|otf)$/</code> 使用url-loader url-loader 也可以处理图片和字体 可以设置较小的资源自动base64</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">rules</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|svg|jpg|git)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&#39;url-loader&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">10240</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

    <span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>webpack中的文件监听</p><p>文件监听是在发现源码发生变化时，自动重新构建出新的输出文件。</p><p>webpack 开启监听模式，有两种方式:</p><ol><li>启动 webpack命令时，带上--watch参数</li><li>在配置webpack.config.js中设置 watch: true</li></ol><p>唯一缺陷：每次需要手动 刷新浏览器</p><details class="custom-container details"><summary>文件监听原理</summary><p>轮询判断文件的最后编辑时间是否变化 某个文件发生了变化，并不会立即告诉监听者，而是先缓存起来，等aggregateTimeout</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">watch</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//默认false</span>
    <span class="token literal-property property">watchOptions</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">ignored</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token comment">// 默认空，不监听的文件(夹),支持正则匹配</span>
        <span class="token literal-property property">aggregateTimeout</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token comment">// 监听到变化后会等300ms再去执行，默认300</span>
        <span class="token literal-property property">poll</span><span class="token operator">:</span><span class="token number">1000</span> <span class="token comment">// 判断文件是否变化是通过轮询问系统指定文件有没变化实现的，默认每秒问1000次</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></details><p>热更新 webpack-dev-server</p><ul><li>WDS 不刷新浏览器</li><li>WDS 不输出文件，而是放在内存中</li><li>使用HotModuleReplacementPlugin插件 <code>webpack-dev-server --open</code></li></ul><p>热更新 使用webpack-dev-middleware WDS将 webpack输出的文件传输给服务器 适用于灵活的定制场景</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> express<span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;express&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpack<span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpackDevMiddleware<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-dev-middleware&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app<span class="token operator">=</span><span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./webpack.config.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> compiler<span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">webpackDevMiddleware</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token literal-property property">publicPath</span><span class="token operator">:</span> config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>publicPath
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;app listening on port 3000&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>热更新的原理分析</p><ul><li>Webpack Compile: 将JS编译成 Bundle</li><li>HMR Server: 将热更的文件输出给 HMR Runtime</li><li>Bundle server: 提供文件在浏览器的访问</li><li>HMR Runtime: 会被注入到浏览器，更新文件的变化</li><li>bundle.js: 构建输出的文件</li></ul><p><img src="/vue-press/assets/HMR-principal.1526aa68.png" alt="HMR原理分析"></p><ul><li>什么是文件指纹? 打包后输出的文件名的后缀 hash串 文件指纹如何生成</li><li>Hash：和整个项目的构建相关，只要项目文件有修改，整个项目构建的hash值就会更改</li><li>Chunkhash：和webpack打包的chunk有关，不同的entry会生成不同的chunkhash值</li><li>Contenthash: 根据文件内容来定义hash，文件内容不变，则contenthash不变</li></ul><p>JS的文件指纹设置 设置output的filename，使用[chunkhash] <code>output:{ filename: &#39;[name][chunkhash:8].js&#39; }</code> CSS文件的指纹设置 设置MiniCssExtractPlugin的filename,使用[contenthash]</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[name][contenthash:8].css</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>图片文件的指纹设置 设置file-loader的name，使用[hash] <code>use: [{loader:&#39;file-loader&#39;,options:{name:&#39;img/[name][hash:8].[ext]&#39;}}]</code></p><table><thead><tr><th>占位符名称</th><th>含义</th></tr></thead><tbody><tr><td>ext</td><td>资源的后缀名</td></tr><tr><td>name</td><td>文件名称</td></tr><tr><td>path</td><td>文件的相对路径</td></tr><tr><td>folder</td><td>文件所在的文件夹</td></tr><tr><td>contenthash</td><td>文件的内容hash，默认md5生成</td></tr><tr><td>hash</td><td>文件内容的Hash,默认md5生成</td></tr><tr><td>emoji</td><td>一个随机的指代文件内容的emoji</td></tr></tbody></table><p>代码压缩 HTML压缩 CSS压缩 JS压缩</p><p>JS文件的压缩 内置了uglifyjs-webpack-plugin CSS文件的压缩 使用optimize-css-assets-webpack-plugin，同时使用 cssnano</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">OptimizeCSSAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">assetsNameRegExp</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">cssProcessor</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;cssnano&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>html文件的压缩 修改html-webpack-plugin, 设置压缩参数</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">template</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;src/search.html&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;search.html&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">chunks</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&#39;search&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">inject</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">minify</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">html5</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">collapseWhitespace</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">preserveLineBreaks</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token literal-property property">minifyCSS</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">minifyJS</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">removeComments</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token literal-property property">的定义</span><span class="token operator">:</span> font<span class="token operator">-</span>size <span class="token keyword">of</span> the root elementrem 和 px 对比
移动端<span class="token constant">CSS</span> px自动转换成rem
使用px2rem<span class="token operator">-</span>loader
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_03-webpack进阶用法" tabindex="-1"><a class="header-anchor" href="#_03-webpack进阶用法" aria-hidden="true">#</a> 03 webpack进阶用法</h3><ol><li>当前构建的问题 每次构建的时候不会清理目录，造成构建的输出目录output文件越来越多</li></ol><p>通过 npm scripts 清理构建目录 <code>rm -rf ./dist &amp;&amp; webpack</code><code>rimraf ./dist &amp;&amp; webpack</code></p><p>自动清理构建目录 避免构建前每次都需要手动删除dist 使用clean-webpack-plugin ,默认会删除output指定的输出目录</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> plugins<span class="token operator">=</span><span class="token punctuation">[</span> <span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> 
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="2"><li>CSS3属性为什么需要前缀?</li></ol><ul><li>Trident(-ms)</li><li>Geko(-moz)</li><li>Webkit(-webkit)</li><li>Presto(-o)</li></ul><p>举个例子</p><div class="language-css ext-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">.box</span><span class="token punctuation">{</span>
    <span class="token property">-moz-border-radius</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
    <span class="token property">-webkit-border-radius</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
    <span class="token property">-o-border-radius</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>PostCSS插件 autoprefixer 自动补齐CSS3前缀 使用 autoprefixer 插件 根据 CanIUse规则</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> module<span class="token punctuation">.</span>rules<span class="token operator">=</span>
<span class="token punctuation">{</span>
    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.less$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token string">&#39;style-loader&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;css-loader&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;less-loader&#39;</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&#39;postcss-loader&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span><span class="token punctuation">{</span> <span class="token function-variable function">plugins</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">[</span>
                    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;autoprefixer&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token literal-property property">browsers</span><span class="token operator">:</span><span class="token punctuation">[</span> <span class="token string">&quot;last 2 version&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&gt;1%&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;iOS 7&quot;</span> <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="3"><li>浏览器的分辨率 CSS 媒体查询实现响应式布局</li></ol><div class="language-css ext-css line-numbers-mode"><pre class="language-css"><code><span class="token atrule"><span class="token rule">@media</span> screen <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 980px<span class="token punctuation">)</span></span><span class="token punctuation">{</span>
    <span class="token selector">.header</span> <span class="token punctuation">{</span> <span class="token property">width</span><span class="token punctuation">:</span> 900px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token atrule"><span class="token rule">@media</span> screen <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 480px<span class="token punctuation">)</span></span><span class="token punctuation">{</span>
    <span class="token selector">.header</span> <span class="token punctuation">{</span> <span class="token property">width</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token atrule"><span class="token rule">@media</span> screen <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 350px<span class="token punctuation">)</span></span><span class="token punctuation">{</span>
    <span class="token selector">.header</span> <span class="token punctuation">{</span> <span class="token property">width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="4"><li>rem 是什么</li></ol><blockquote><p>W3C 对 <code>rem</code> 的定义: font-size of the root element</p></blockquote><p>rem 和 px 对比</p><ul><li>rem 是相对单位</li><li>px 是绝对单位</li></ul><p>移动端CSS px自动转换成rem</p><p>使用<code>px2rem-loader</code> 页面渲染时计算根元素的font-size值</p><ul><li>可以使用手淘的lib-flexible库</li><li>https://github.com/amfe/lib-flexible</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> rules1<span class="token punctuation">.</span>use<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token string">&#39;style-loader&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;css-loader&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;less-loader&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&#39;px2rem-loader&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token literal-property property">remUnit</span><span class="token operator">:</span> <span class="token number">75</span><span class="token punctuation">,</span>
            <span class="token literal-property property">remPecision</span><span class="token operator">:</span> <span class="token number">8</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>资源内联的意义 代码层面：</p><ul><li>页面框架的初始化脚本</li><li>上报相关打点</li><li>css内联避免页面闪动 请求层面: 减少HTTP网络请求数</li><li>小图片或者字体内联 url-loader</li></ul><p>HTML 和 JS 内联</p><p>raw-loader 内联 html</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">$<span class="token punctuation">{</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;raw-loader!babel-loader!./meta.html&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>raw-loader 内联 js</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">$<span class="token punctuation">{</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;raw-loader!babel-loader!../node_modules/lib-flexible&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>css 内联 方案一 借助 style-loader 方案二 html-inline-css-webpack-plugin</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> rules1<span class="token punctuation">.</span>use<span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span> 
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&#39;style-loader&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token literal-property property">insertAt</span><span class="token operator">:</span> <span class="token string">&#39;top&#39;</span><span class="token punctuation">,</span><span class="token comment">// 样式插入到&lt;head&gt;</span>
            <span class="token literal-property property">singleton</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">// 将所有的style标签合并成一个</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&#39;css-loader&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;sass-loader&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>多页面应用(PWA)概念</p><blockquote><p>每一次页面跳转的时候，后台服务器都会给返回一个新的html文档，</p><p>这种类型的网站也就是多页面网站，也叫做多页面应用</p></blockquote><p>多页面打包基本思路</p><p>每个页面对应一个entry，一个html-webpack-plugin 缺点：每次新增或删除页面需要改webpack配置</p><p>多页面打包 通用方案</p><p>动态获取entry 和设置 html-webpack-plugin 利用 glob.sync</p><ul><li>entry: glob.sync(path.join(__dirname,&#39;./src/*/index.js&#39;)),</li></ul><p>使用 source map</p><p>作用：通过source map定位到源码</p><ul><li>source map 科普 阮一峰javascript_source_map</li></ul><p>开发环境开启，线上环境关闭</p><ul><li>线上排查问题的时候可以将sourcemap上传到错误监控系统</li></ul><p>source map 关键字</p><p>eval: 使用eval包裹模块代码</p><p>source map： 产生.map文件</p><p>cheap： 不包含列信息</p><p>inline： 将.map作为DataURI嵌入，不单独产生.map文件</p><p>module：包含loader的sourcemap</p><p>source map 类型</p><ul><li>none =prod yes</li><li>eval</li><li>cheap-eval-source-map</li><li>cheap-module-source-map</li><li>eval-source-map</li><li>cheap-source-map =prod yes</li><li>cheap-module-source-map =prod yes</li><li>inline-cheap-source-map</li><li>inline-cheap-module-source-map</li><li>source-map =prod yes</li><li>inline-source-map</li><li>hidden-source-map =prod yes</li></ul><p>基础库分离 思路：将react、react-dom 基础包通过cdn引入，不打入bundle中 方法：使用html-webpack-externals-plugin</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>cosnt plugins<span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackExternalsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">externals</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">,</span><span class="token literal-property property">entry</span><span class="token operator">:</span><span class="token string">&#39;//cdn/react.min.js?v=123&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token string">&#39;react-dom&#39;</span><span class="token punctuation">,</span><span class="token literal-property property">entry</span><span class="token operator">:</span><span class="token string">&#39;//cdn/react-dom.min.js?v=123&#39;</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>使用SplitChunksPlugin 进行公共脚本分离 webpack4 内置的，替代CommonsChunkPlugin 插件</p><p>chunks 参数说明：</p><ul><li>async 异步引入的库进行分离(默认)</li><li>initial 同步引入的库进行分离</li><li>all 所有引入的库进行分离(推荐)</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
<span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">splitChunks</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">&#39;async&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">minSize</span><span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
        <span class="token literal-property property">maxSize</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">minChunks</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">maxAsyncRequests</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token literal-property property">maxInitialRequests</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">automaticNameDelimiter</span><span class="token operator">:</span> <span class="token string">&#39;~&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cacheGroups</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">vendors</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
            <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">10</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>利用SplitChunksPlugin 分离基础包</p><p>test: 匹配出需要分离的包</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>optimization<span class="token punctuation">.</span>splitChunks<span class="token punctuation">.</span>cacheGroups<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">commons</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(react|react-dom)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;vendors&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">&#39;all&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>利用SplitChunksPlugin 分离公共文件</p><p>minChunks: 设置最小引用次数为2次 minSize：分离的包体积的大小</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>optimiaztion<span class="token punctuation">.</span>splitChunks<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">minSize</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">cacheGroups</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">commons</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;commons&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">&#39;all&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">minChunks</span><span class="token operator">:</span> <span class="token number">2</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Tree Shaking(摇树优化) 概念： 1个模块可能有多个方法，只要其中的某个方法使用到了，则整个文件都会被打到bundle里面去，tree-shaking就是只把用到的方法打入bundle，没用到的方法会在uglify阶段被擦除掉。</p><p>使用：webpack默认支持，在.babelrc中里设置modules:false即可</p><ul><li>production mode的情况下默认开启</li></ul><p>要求: 必须是ES6的语法,CJS的方式不支持</p><p>DCE(Dead code elimination) 代码不会被执行,不可到达 代码执行的结果不会被用到 代码只会影响死变量(只写不读)</p><p>Tree-Shanking原理 利用ES6 模块的特点:</p><ul><li>只能作为模块顶层的语句出现(静态编译)</li><li>import的模块名只能是字符串常量</li><li>import binding 是 immutable的 代码擦除:uglify阶段删除无用代码</li></ul><p>现象:构建后的代码存在大量闭包代码</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>    <span class="token comment">//a.js</span>
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">&#39;xxxx&#39;</span><span class="token punctuation">;</span>
    <span class="token comment">//b.js</span>
    <span class="token keyword">import</span> index <span class="token keyword">from</span> <span class="token string">&#39;./a&#39;</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>---&gt;</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span>__webpack_exports__<span class="token punctuation">,</span>webpack_require__</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _js_index_WEBPACK_IMPORTED_MODULE_0__<span class="token operator">=</span><span class="token function">__webpack_require__</span><span class="token punctuation">(</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__js_index_WEBPACK_IMPORTED_MODULE_0__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>会导致什么问题? 大量作用域包裹代码,导致体积增大(模块越多越明显) 运行代码时创建的函数作用域变多,内存开销变大</p><p>模块转换分析</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> helloworld <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./helloworld&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&#39;../../common&#39;</span><span class="token punctuation">;</span>

document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">helloworld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>---&gt;</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* harmony import */</span> <span class="token keyword">var</span> _common__WEBPACK_IMPORTED_MODULE_0__<span class="token operator">=</span> <span class="token function">__webpack_requrie__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* harmony import */</span> <span class="token keyword">var</span> _common__WEBPACK_IMPORTED_MODULE_1__<span class="token operator">=</span> <span class="token function">__webpack_requrie__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>结论:</p><ul><li>被webpack转换后的模块会带上一层包裹</li><li>import 会被转换成 __webpack_require</li></ul><p>进一步分析webpack的模块机制 分析:</p><ul><li>打包出来的是一个IIFE(匿名闭包)</li><li>modules是一个数组,每一项是一个模块初始化函数</li><li>__webpack_require 用来加载模块,返回 modules.exports</li><li>通过<code>WEBPACK_REQUIRE_METHOD(0)</code> 启动程序</li></ul><p>scope hoisting原理 原理: 将所有模块的代码按照引用顺序放在一个函数作用域里,然后适当的重命名一些变量以防止变量名冲突 对比: 通过scope hoisting可以减少函数声明代码和内存开销 scope hoisting使用 webpack mode为production 默认开启 必须是ES6语法 CJS不支持</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>    <span class="token keyword">const</span> plugins<span class="token operator">=</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>ModuleConcatenationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>代码分割的意义</p><p>对于大的web应用来讲,将所有的代码都放在一个文件中显然是不够有效的, 特别是当你的某些代码是在某些特殊的时候才会被使用到.webapck有一个功能就是将你的 代码库分割成chunks(语块),当代码运行到需要它们的时候在进行加载.</p><p>适用的场景: 抽离相同代码到一个共享块 脚本懒加载,使得初始下载的代码更小</p><p>懒加载JS脚本的方式 CommonjS: require.ensure ES6: 动态import(目前还没原生支持,需要babel转换)</p><p>如果使用动态 import? 安装babel插件 @babel/plugin-syntax-dynamic-import</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> plugins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&#39;@babel/plugin-syntax-dynamic-import&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>代码分割效果 Assert Size Chunks xxxx.js 176 bytes 2 [emmitted]</p><p>ESLint的必要性 案例: 某手机系统的webview而没有使用X5内核,解析JSON时遇到重复key报错,导致白屏</p><blockquote><p>如何避免类似代码问题?</p></blockquote><p>行业里优秀的 ESLint 规范实践 腾讯:</p><ul><li>alloyteam 团队-&gt; eslint-config-alloy</li><li>ivweb 团队-&gt; eslint-config-ivweb</li></ul><p>制定团队的ESLint 规范 不重复早轮子,基于 eslint:recommend 配置并改进 能够帮助发现代码错误的规则,全部开启 帮助保持团队的代码风格统一,而不是限制开发体验</p><p>ESLint如何落地 和CI/CD系统集成,和webpack集成 方案一: webpack与CI/CD集成 <strong>CI PIPELINE</strong> 增加 lint pipeline 本地开发阶段增加pre commit钩子</p><ol><li>安装husky</li><li>增加npm script -&gt; precommit lint-staged</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;lint-staged&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span> linters<span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;*.{js,scss}&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;eslint --fix&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;git add&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>方案二: webpack与ESLint集成 使用eslint-loader,构建时检查JS规范</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>rules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>use<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&#39;babel-loader&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;eslint-loader&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>webpack打包库和组件 webpack除了可以用来打包应用,也可以用来打包js库 实现一个大整数加法的打包</p><ul><li>需要打包压缩版和非压缩版本</li><li>支持AMD/CJS/CJS/ESM 模块引入 库的目录结构和打包要求 打包输出的库名称:</li><li>未压缩版 large-number.js</li><li>压缩版 large-number.min.js</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>|-/dist
|--large-number.js
|--large-number.min.js
|-webpack.config.js
|-package.json
|-/src
|--index.js
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>支持的使用方式 ESM: <code>import * as largeNumber from &#39;large-number&#39;; largeNumber(a,b);</code></p><p>CJS: <code>const largeNumber = require(&#39;large-number&#39;); largeNumber(a,b);</code></p><p>AMD: <code>require([&#39;large-number&#39;],function(largeNumber){ largeNumber(a,b);});</code></p><p>可以直接通过script引入</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/large-number<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">// global variable</span>
    <span class="token function">largeNumber</span><span class="token punctuation">(</span><span class="token string">&#39;999&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Property in the window object</span>
    window<span class="token punctuation">.</span><span class="token function">largeNumber</span><span class="token punctuation">(</span><span class="token string">&#39;999&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如何将库暴露出去? library: 指定库的全局变量 libraryTarget: 支持库的引入方式</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string-property property">&#39;large-number&#39;</span><span class="token operator">:</span> <span class="token string">&#39;./src/index.js&#39;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&#39;large-number.min&#39;</span><span class="token operator">:</span> <span class="token string">&#39;./src/index.js&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;[name].js&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token string">&#39;largeNumber&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">libraryExport</span><span class="token operator">:</span><span class="token string">&#39;default&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">libraryTarget</span><span class="token operator">:</span><span class="token string">&#39;umd&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>如何只对 .min压缩 通过inclue设置 只压缩min.js 结尾的文件</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>optimization<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">minimize</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">minmizer</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">inclue</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.min\.js$</span><span class="token regex-delimiter">/</span></span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>设置入口文件 package.json的main字段为 index.js</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code> <span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">)</span> module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./dist/large-number.min.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">else</span> module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./dist/large-number.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>页面打开过程 服务端渲染(SSR)是什么 渲染:HTML+CSS+JS+Data -&gt; 渲染后的HTML</p><p>服务端: 所有模板等资源都存在服务端 内网机器拉取数据更快 一个HTML返回所有数据</p><p>浏览器和服务器交互流程 请求开始-server-{html-template,data}-serverRender -浏览器解析并渲染-加载并执行js和其他资源-页面完全可交互</p><p>客户端渲染vs服务端渲染</p><table><thead><tr><th></th><th>客户端渲染</th><th>服务端渲染</th></tr></thead><tbody><tr><td>请求</td><td>多个请求(HTML,数据等)</td><td>1个请求</td></tr><tr><td>加载过程</td><td>HTML&amp;数据串行加载</td><td>1个请求返回HTML和数据</td></tr><tr><td>渲染</td><td>前端渲染</td><td>服务端渲染</td></tr><tr><td>可交互</td><td>图片等静态资源加载完成,JS逻辑执行完可交互</td><td></td></tr></tbody></table><p>总结: 服务端渲染(SSR)的核心是减少请求</p><p>SSR的优势</p><ol><li>减少白屏时间</li><li>对于SEO友好</li></ol><p>SSR代码实现思路 服务端</p><ul><li>使用 react-dom/server的 renderToString 方法将React组件渲染成字符串</li><li>服务端路由返回对应的模板 客户端</li><li>打包出针对服务端的组件</li></ul><p>Webapck ssr打包存在的问题 浏览器全局变量(Node.js中 没有 document,window);</p><ul><li>组件适配: 将不兼容的组件根据打包环境进行适配</li><li>请求适配: 将fetch或者ajax发送请求的写法改成<code>isomorphic-fetch</code>或者<code>axios</code> 样式问题(Node.js无法解析样式css)</li><li>方案一: 服务端打包通过ignore-loader忽略掉css的解析</li><li>方案二: 将style-loader替换成isomorphic-style-loader</li></ul><p>如何解决样式不显示的问题?</p><p>使用打包出来的浏览器端HTML为模板</p><p>设置占位符,动态插入组件 <code>&lt;!--HTML_PLACEHOLDER--&gt;</code></p><p>首屏数据如何处理 服务端获取数据 替换占位符</p><p>当前构建时的日志显示 展示一大堆日志,很多并不是开发者关注 统计信息 stats</p><table><thead><tr><th>preset</th><th>alternative</th><th>description</th></tr></thead><tbody><tr><td>errors-only</td><td>none</td><td>只在发生错误时输出</td></tr><tr><td>minimal</td><td>none</td><td>只在发生错误或有新的编译时输出</td></tr><tr><td>none</td><td>false</td><td>没有输出</td></tr><tr><td>normal</td><td>true</td><td>标准输出</td></tr><tr><td>verbose</td><td>none</td><td>全部输出</td></tr></tbody></table><p>如何优化命令行的构建日志 使用 friendly-errors-webpack-plugin</p><ul><li>success 构建成功的日志提示</li><li>warning 构建警告时的日志提示</li><li>error 构建报错时的日志提示</li></ul><p>stats 设置成erros-only</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> plugins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">FriendlyErrorsWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> stats<span class="token operator">=</span><span class="token string">&quot;errors-only&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如何判断构建是否成功? 在CI/CD 的 pipeline 或者发布系统需要知道当前构建状态</p><p>每次构建完成后输入 <code>echo $?</code> 获取错误码</p><p>构建异常和中断处理 webpack4之前的版本构建失败不会抛出错误码(error code) Node.js 中的 prcess.exit 规范</p><ul><li>0 表示成功完成,回调函数中,err 为null</li><li>非0 表示执行失败,回调函数中,error不为null,error.code 就是传给exit的数字</li></ul><p>如何主动捕获并处理构建错误? compiler在每次构建结束后出发 done这个 hook</p><p>process.exit 主动处理构建报错</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hook<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;done&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span>erros <span class="token operator">&amp;&amp;</span> stats<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span>erros<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;--watch&#39;</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;build error&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_04-编写可维护的webpack构建配置" tabindex="-1"><a class="header-anchor" href="#_04-编写可维护的webpack构建配置" aria-hidden="true">#</a> 04 编写可维护的webpack构建配置</h3><p>构建配置抽离成npm包的意义</p><p>通用性</p><ul><li>业务开发者无需关注构建配置</li><li>统一团队构建脚本</li></ul><p>可维护性</p><ul><li>构建配置合理的拆分</li><li>README文档、ChangeLog文档</li></ul><p>质量</p><ul><li>冒烟测试、单元测试、测试覆盖率</li><li>持续集成</li></ul><p>构建配置管理的 可选方案</p><ul><li>通过多个配置文件管理不同环境的构建， webpack --config参数进行控制</li><li>将构建配置设计成一个库，比如hjs-webpack，Neutino，webpack-blocks</li><li>抽成一个工具进行管理，比如create-react-app，kyt，nwb</li><li>将所有配置放在一个文件，通过 --env 参数控制分支选择</li></ul><p>构建配置包设计 通过多个配置文件管理不同环境的webpack配置</p><ul><li>基础配置 webpack.base.js</li><li>开发环境 dev</li><li>生产环境 prod</li><li>ssr环境 ssr</li></ul><p>抽离成一个npm包统一管理</p><ul><li>规范： git commit日志，readme，eslint规范，semver规范</li><li>质量： 冒烟测试，单元测试，测试覆盖旅和CI</li></ul><p>通过webpack-merge 组合配置</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-merge&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token function">merge</span><span class="token punctuation">(</span>baseConfig<span class="token punctuation">,</span>devConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>功能模块设计</p><ul><li>基础配置：base <ul><li>资源解析:ES6,React,CSS,Less,图片,字体</li><li>样式增强:CSS前缀补齐，CSS px转换成rem</li><li>目录清理</li><li>多页面打包</li><li>命令行信息显示优化</li><li>错误捕获和处理</li><li>CSS提取成一个单独的文件</li></ul></li><li>开发阶段配置： <ul><li>代码热更新：CSS热更新，JS热更新</li><li>sourcemap</li></ul></li><li>生产阶段配置： <ul><li>代码压缩</li><li>文件指纹</li><li>Tree Shaking</li><li>Scope Hoisting</li><li>速度优化： 基础包CDN</li><li>体积优化： 代码分割</li></ul></li><li>SSR配置： <ul><li>output的libraryTarget设置</li><li>CSS解析的ignore</li></ul></li></ul><p>目录结构设计 lib 放置源代码 test 放置测试代码 使用eslint规范构建脚本 使用 eslint-config-airbnb-base eslint --fix 可以自动处理空格</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;parser&quot;</span><span class="token operator">:</span> <span class="token string">&quot;babel-eslint&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;extends&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eslint-config-airbnb-base&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;env&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string-property property">&quot;browser&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;node&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>冒烟测试 smoke testing 冒烟测试是指对提交测试的软件在进行详细深入的测试之前而进行的预测试， 这种预测试的主要目的是暴露导致软件需重新发布的基本功能失效等严重问题</p><p>冒烟测试执行 构建是否成功 每次构建完成build目录是否有内容输出</p><ul><li>是否有JS、CSS等静态资源文件</li><li>是否有HTML文件</li></ul><p>判断是否构建成功 在示例项目里面运行构建，看看是否有报错</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rimraf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;rimraf&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Mocha <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mocha&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mocha <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mocha</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token string">&#39;10000ms&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">chdir</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">rimraf</span><span class="token punctuation">(</span><span class="token string">&#39;./dist&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> prodConfig<span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../../lib/webpack.prod&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">webpack</span><span class="token punctuation">(</span>prodConfig<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>stats</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">colors</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token literal-property property">chunkMoudles</span><span class="token operator">:</span><span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;\n&#39;</span><span class="token operator">+</span><span class="token string">&#39;Complier success, begin mocha test&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>判断基本功能是否正常 编写mocha测试用例 是否有JS，CSS静态资源，HTML文件;</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> glob <span class="token operator">=</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;glob-all&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;checking generated file exists&#39;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should generate html files&#39;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> files<span class="token operator">=</span>glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;./dist/index.html&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;./dist/search.html&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;No html files found&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should generate js &amp; css files&#39;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> files<span class="token operator">=</span>glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;./dist/index_*.js&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;./dist/index_*.css&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;No files found&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>单元测试与测试覆盖率 单纯测试框架，需要断言库</p><ul><li>chai</li><li>should.js</li><li>expect</li><li>better-assert</li></ul><p>集成框架 开箱即用</p><ul><li>Jasmine</li><li>Jest</li></ul><p>极简API</p><p>编写单元测试用例</p><ul><li>技术选型: Mocha + Chai</li><li>测试代码: describe + it + expect</li><li>测试命令: mocha add.test.js</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> expect <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;chai&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expect<span class="token punctuation">;</span>
<span class="token keyword">const</span> add <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../src/add&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;use expect: src/add.js&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;add(1,2)===3&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>单元测试接入</p><ol><li>安装 mocha + chai</li><li>新建test目录，并增加 [name].test.js测试文件</li><li>在package.json中 scripts 字段增加 test命令 <code>node_modules/mocha/bin/_mocha</code></li><li>执行测试命令 <code>npm run test</code></li></ol><p>持续集成的作用 优点： 快速发现错误，放置分支大幅偏离主干</p><p>核心措施是，代码集成到主干之前，必须通过自动化测试。只要有一个测试用例失效就不能集成。</p><p>Github最流行的CI （top10 Travis CI,Circle CI,Jenkins,AppVeyor,CodeShip,Drone,Semaphore CI,Buildkite,Wercker,TeamCity</p><p>接入Travis CI</p><ol><li>https://travis-ci.org 使用github账号登录</li><li>在/account/repositories 为项目开启</li><li>项目根目录下新增 travis.yml</li></ol><p>yml文件内容 install安装项目依赖 ，script运行测试用例</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">language</span><span class="token punctuation">:</span> node_js

<span class="token key atrule">sudo</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">apt</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">directories</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> node_modules

<span class="token key atrule">node_js</span><span class="token punctuation">:</span> stable <span class="token comment"># 设置相应版本</span>

<span class="token key atrule">install</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> npm install <span class="token punctuation">-</span>D <span class="token comment"># 安装构建依赖器</span>
    <span class="token punctuation">-</span> cd ./test/template<span class="token punctuation">-</span>project
    <span class="token punctuation">-</span> npm install <span class="token punctuation">-</span>D <span class="token comment"># 安装构建依赖器</span>

<span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> npm test
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>发布到npm 添加用户 <code>npm adduser</code> 升级版本</p><ul><li>升级补丁版本号 npm version patch</li><li>升级小版本号 npm version minor</li><li>升级大版本号 npm version major 版本发布： npm publish</li></ul><p>git规范和changelog生成 良好的 git commit规范优势：</p><ul><li>加快code-review流程</li><li>根据git commit的元数据生成changelog</li><li>后续维护者可以知道feature被修改的原因</li></ul><p>技术方案, 提交格式- 统一团队commit标准 extends angular-gitcommit 使用commitize工具，validate-commit-msg工具，gitlab serverhook， 使用conventional-changelog</p><p>提交格式要求</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;
&lt;BLANK LINE&gt;
&lt;body&gt;
&lt;BLANK LINE&gt;
&lt;footer&gt;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>type代表某次提交的类型</p><ul><li>feat 新增feature</li><li>fix 修复bug</li><li>docs 仅仅修改了文档，比如README，CHANGELOG，CONTRIBUTE等等</li><li>style 仅仅修改了空格，格式缩进，标点符号等，不改变代码逻辑</li><li>refactor 代码重构，没有加新的功能或者修复bug</li><li>perf 优化相关，比如提升性能、体验</li><li>test 测试用例 包括单元测试 集成测试等</li><li>chore 改变构建流程、或者增加依赖库 工具等</li><li>rever 同GIT回滚</li></ul><p>本地开发阶段增加preCommit钩子 安装husky 通过commitmsg钩子校验信息</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;commitmsg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;validate-commit-msg&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;changelog&quot;</span><span class="token operator">:</span> <span class="token string">&quot;conventional-changelog -p angular -i CHANGELOG.md -s -r 0&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;validate-commit-msg&quot;</span><span class="token operator">:</span><span class="token string">&quot;^2.11&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;conventional-changelog-cli&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.2&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;husky&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.13&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>开源项目版本信息案例</p><ul><li>软件的版本通常由三位组成，形如X.Y.Z</li><li>版本是严格递增的</li><li>在发布重要版本时，可以发布alpha,rc等先行版本</li><li>aplha，rc等修饰版本的关键字后面可以带上次数和meta信息</li></ul><p>遵守semsemver 规范的优势 避免出现循环依赖 依赖冲突减少</p><p>语义化版本(Semantic Versioning)规范格式 主版本号： 当你做了不兼容的API修改 次版本号： 当你做了向下兼容的功能新增 修订号: 当你做了向下兼容的问题修正</p><p>先行版本号</p><p>先行版本号可以作为发布正式版之前的版本，格式是在修订版本号后面加上一个连接号(-), 再加上一连串以点(.)分割的标识符，标识符可以由英文数字和连接号[0-9A-Za-z-]组成</p><ul><li>alpha 是内部测试版，一般不向外发布，会有很多bug，一般只有测试人员使用。</li><li>beta 也是测试版，这个阶段的版本不会一直加入新的功能，在Alpha版本之后推出</li><li>rc Release Candidate 系统平台上就是发行候选版本。RC版本不会再加入新的功能了，主要着重于除错</li></ul><h3 id="_05-webpack构建速度和体积优化策略" tabindex="-1"><a class="header-anchor" href="#_05-webpack构建速度和体积优化策略" aria-hidden="true">#</a> 05 Webpack构建速度和体积优化策略</h3><p>初级分析：使用webpack内置的stats</p><p>stats：构建的统计信息 package.json 中使用 stats <code>&quot;build:stats&quot;:&quot;webpack --env production --json &gt; stats.json&quot;</code>,</p><p>Node.js 使用</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> webpack <span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./webpack.config.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&#39;production&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>stats</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&#39;errors-only&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>** 颗粒度太粗，看不出问题所在</p><p>速度分析： 使用speed-measure-webpack-plugin 代码示例</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> SpeedMeasurePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;speed-measure-webpack-plugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> smp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpeedMeasurePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpackConfig <span class="token operator">=</span> smp<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">MyPugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">MyOtherPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以看到每个loader和插件执行耗时</p><p>速度分析插件作用 分析整个打包总耗时 每个插件和loader的耗时情况</p><p>webpack-bundle-analyzer 分析体积 代码示例</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> BunldeAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-bundle-analyzer&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>构建完成后会在8888端口展示大小 可以分析哪些问题</p><ul><li>依赖的第三方模块文件大小</li><li>业务里面的组件代码大小</li></ul><p>使用高版本的webpack和Node.js 构建时间降低了60%-98%；</p><p>使用webpack4 优化原因</p><ul><li>V8带来的优化（for of替代forEach Map Set替代Object includes替代indexOf）</li><li>默认使用更快的md4 hash算法</li><li>webpack AST可以直接从loader传递给AST，减少解析时间</li><li>使用字符串方法替代正则表达式</li></ul><p>多进程/多实例构建：资源并行解析可选方案 thread-loader 可选方案 parallel-webpack HappyPack 多进程/多实例：使用HappyPack解析资源 原理：每次webpack 解析一个模块，HappyPack会将它及它的依赖分配给worker线程中 代码示例</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span>plugins<span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">HappyPack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;jsx&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">threads</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
        <span class="token literal-property property">loaders</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&#39;babel-loader&#39;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">HappyPack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;styles&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">threads</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">loaders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;style-loader&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;css-loader&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;less-loader&#39;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>多进程/多实例：使用thread-loader解析资源 原理：每次webpack解析一个模块 thread-loader会将它及它的依赖分配给worker线程中</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> json<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;module.rules&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
            <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token literal-property property">loader</span><span class="token operator">:</span><span class="token string">&#39;thread-loader&#39;</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">options</span><span class="token operator">:</span><span class="token punctuation">{</span>
                        <span class="token literal-property property">workers</span><span class="token operator">:</span> <span class="token number">3</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">&#39;babel-loader&#39;</span><span class="token punctuation">,</span>
                <span class="token comment">// &#39;eslint-loader&#39;</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>多进程/多实例：并行压缩 方法一：使用parallel-uglify-plugin插件</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> ParallelUglifyPlugin<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-parallel-uglify-plugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">ParallelUglifyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">uglifyJS</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">beautify</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">comments</span><span class="token operator">:</span> <span class="token boolean">false</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">compress</span><span class="token operator">:</span><span class="token punctuation">{</span>
                    <span class="token literal-property property">warnings</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">drop_console</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">collapse_vars</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">reduce_vars</span><span class="token operator">:</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>并行压缩 方法二：uglifyjs-webpack-plugin 开启parallel参数</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> UglifyJsPlugin<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;uglifyjs-webpack-plugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">UglifyJsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">uglifyOptions</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token literal-property property">warnings</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token literal-property property">parse</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">mangle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token literal-property property">toplevel</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token literal-property property">nameCache</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token literal-property property">ie8</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token literal-property property">keep_fnames</span><span class="token operator">:</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">parallel</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>并行压缩 方法三：terser-webpack-plugin 开启 parallel参数</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> TerserPlugin<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;terser-webpack-plugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">optimization</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">minimizer</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">parallel</span><span class="token operator">:</span> <span class="token number">4</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>分包：设置Externals 思路：将 react、react-dom基础包 通过cdn引入，不打入bundle中 方法: 使用html-webpack-externals-plugin</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">HtmlWebpackExternalsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">externals</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">&#39;//11.url.cn/now/lib/15.1.0/react-with-addons.min.js?v=1&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">global</span><span class="token operator">:</span> <span class="token string">&#39;React&#39;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token string">&#39;react-dom&#39;</span>
            <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">&#39;//11.url.cn/now/lib/15.1.0/react-dom.min.js?v=1&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">global</span><span class="token operator">:</span> <span class="token string">&#39;ReactDom&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>进一步设置分包：预编译资源模块 思路： 将react、react-dom、redux、react-redux基础包和业务基础包打成一个文件 方法：使用DLLPlugin 进行分包，DllReferencePlugin 对manifest.json引用</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> path<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpack<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">context</span><span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">resolve</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;.js&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;.jsx&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;.json&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;.less&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;.css&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">modules</span><span class="token operator">:</span><span class="token punctuation">[</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;node_modules&#39;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">library</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&#39;react&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;react-dom&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;redux&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;react-redux&#39;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;[name].dll.js&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;./build/library&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token string">&#39;[name]&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;[name]&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">&#39;./build/library/[name].json&#39;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>在webpack.config.js引入</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllReferencePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">manifest</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./build/library/manifest.json&#39;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>引用效果 <code>&lt;script src=&quot;/build/library/library.dll.js&quot;&gt;&lt;/script&gt;</code></p><p>缓存 目的：提升二次构建速度 缓存思路： babel-loader 开启缓存 terser-webpack-plugin 开启缓存 使用cache-loader或者 hard-source-webpack-plugin</p><p>缩小构建目标 目的:尽可能的少构建模块 比如babel-loader不解析node_modules <code>loader:&#39;happypack/loader&#39;,exclude:&#39;node_modules&#39;</code></p><p>减少文件搜索范围 优化 resolve.modules设置（减少模块搜索层级） 优化resolve.mainFields 配置 优化 resolve.extensions 配置 合理使用alias</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">resolve</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">alias</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token literal-property property">react</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;./node_modules/react/dist/react.min.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;node_modules&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;.js&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">mainFields</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;main&#39;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>图片压缩 要求：基于Node库的imagemin或者tinypng API 使用：配置image-webpack-loader</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|svg|jpg|gif|blob)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&#39;file-loader&#39;</span><span class="token punctuation">,</span><span class="token literal-property property">options</span><span class="token operator">:</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">img/[name]</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.[ext]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token punctuation">{</span><span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&#39;image-webpack-loader&#39;</span><span class="token punctuation">,</span><span class="token literal-property property">options</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token literal-property property">mozjpeg</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">progresive</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token literal-property property">quality</span><span class="token operator">:</span> <span class="token number">65</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">optipng</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">enabled</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">pngquant</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">quality</span><span class="token operator">:</span><span class="token string">&#39;65-90&#39;</span><span class="token punctuation">,</span><span class="token literal-property property">speed</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">gifsicle</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">interlaced</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">webp</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">quality</span><span class="token operator">:</span><span class="token number">75</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>Imagemin优点分析 有很多定制选项 可以引入更多第三方优化插件 例如pngquant 可以处理多种图片格式 压缩原理</p><ul><li>pngquant: 是一款png压缩器，通过将图像转为具有alpha通道的更高效的8为PNG格式，可显著减少文件大小</li><li>pngcrush： 其主要目的是通常尝试不同的压缩级别和PNG过滤方法来降低PNG IDAT数据流的大小</li><li>optipng: 其设计灵感来自于pngcrush。optipng可将图像文件重新压缩为更小尺寸，而不是会丢失任何信息</li><li>tinypng：也是将24位png文件转化为更小有索引的8位图片，同时所有非必要的metadata也会剥离掉</li></ul><h4 id="tree-shanking-复习" tabindex="-1"><a class="header-anchor" href="#tree-shanking-复习" aria-hidden="true">#</a> Tree Shanking（复习</h4><p>概念： 1个模块可能有多个方法，只要其中的某个方法使用到了，则整个文件都会被打到 bundle 里面去，tressshaking就是把用到的方法打入bundle，没用到的方法会在uglify阶段被擦除掉</p><p>使用webpack默认支持，在.babelrc里设置modules: false 即可 .production mode情况下默认开启 要求：必须是ES6语法，CJS的方式不支持</p><p>无用的CSS如何删除掉 PurifyCSS便利代码，识别已经用到的CSS class uncss： HTML需要通过jsdom加载，所有的样式通过PostCSS解析，通过 document.querySelector来识别html文件里面不存在的选择器</p><p>在webpack中如何使用PurifyCSS 使用purgress-webpack-plugin 和mini-css-extract-plugin配合使用 和mini-css-extract-plugin</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">filename</span><span class="token operator">:</span><span class="token string">&#39;[name].css&#39;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">PurgecssPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">paths</span><span class="token operator">:</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PATH</span><span class="token punctuation">.</span>src<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/**/*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">nodir</span><span class="token operator">:</span> <span class="token boolean">true</span>`<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>构建体积优化动态polyfill babel-polyfill 打包后体积88.49K!!! Promise的浏览器支持情况</p><table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>是否采用</th></tr></thead><tbody><tr><td>babel-polyfill</td><td>React官方推荐</td><td>包体积大</td><td>x</td></tr><tr><td>babel-plugin-transform-runtime</td><td>能只polyfill到方法</td><td>不能polyfill原型上魔法</td><td>x</td></tr><tr><td>自己map，set的polyfill</td><td>定制化高</td><td>积小小</td><td>x</td></tr><tr><td>polyfill-service</td><td>只给用户回需要的polyfill，社区维护</td><td>部分国内UA挂</td><td>☑️</td></tr></tbody></table><p>Polyfill Service 原理 识别UserAgent 下发不同的Polyfill</p><p>构建体积优化：如何动态PolyfillService polyfill.io 官方提供的服务 <code>&lt;script src=&quot;https://cdn.polyfill.io/v2/polyfill.min.js&quot;&gt;&lt;/script&gt;</code></p><p>基于官方自建的polyfill服务</p><p>体积优化策略总结</p><ul><li>Scope Hoisting</li><li>Tree Shaking</li><li>公用资源分离</li><li>图片压缩</li><li>动态polyfill</li></ul><h3 id="_06-通过源码掌握webpack打包原理" tabindex="-1"><a class="header-anchor" href="#_06-通过源码掌握webpack打包原理" aria-hidden="true">#</a> 06 通过源码掌握webpack打包原理</h3><p>开始： 从webpack命令行说起 通过npm scripts运行 webpack</p><ul><li>开发环境 npm run dev</li><li>生产环境 npm run build</li></ul><p>通过webpack直接运行</p><ul><li>webpack entry.js bundle.js</li></ul><blockquote><p>这个过程发生了什么</p></blockquote><p>查找webpack入口文件 在命令行运行以上命令后，npm会让命令行工具 进入<code>node_modules/.bin</code> 目录查找是否存在webpack.sh或者webpack.cmd文件，如果存在，就执行 不存在则抛出错误 实际入口文件是: node_modules/webpack/in/webpack.js</p><p>分析webpack的入口文件: webpack.js</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>process<span class="token punctuation">.</span>exitCode <span class="token operator">=</span> <span class="token number">0</span>；
<span class="token keyword">const</span> <span class="token function-variable function">runCommand</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">command<span class="token punctuation">,</span>args</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">isInstalled</span><span class="token operator">=</span><span class="token parameter">packagName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> CLIs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span>
<span class="token comment">// webpack-command</span>
<span class="token keyword">const</span> installcides<span class="token operator">=</span><span class="token constant">CLI</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">cli</span><span class="token operator">=&gt;</span>cli<span class="token punctuation">.</span>installed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>installedClis<span class="token punctuation">.</span>length<span class="token operator">===</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span>
<span class="token punctuation">(</span>installedClis<span class="token punctuation">.</span>length<span class="token operator">===</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>启动后的结果 webpack最终找到 webpack-cli(webpack-command)这个 npm包 并且执行cli</p><p>webpack-cli做的事情 引入yargs，对命令进行定制 分析命令行参数，对各个参数进行转换，组成编译配置项 引用webpack，根据配置项进行编译和构建</p><p>从NON_COMPILATION_CMD分析出不需要编译的命令 webpck-cli 处理不需要经过编译的命令</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">NON_COMPILATION_ARGS</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./utils/constants&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">NON_COMPILATION_CMD</span><span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>arg <span class="token operator">===</span> <span class="token string">&#39;serve&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        global<span class="token punctuation">.</span>precess<span class="token punctuation">.</span>argv<span class="token operator">=</span>global<span class="token punctuation">.</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token operator">=&gt;</span>a<span class="token operator">!==</span><span class="token string">&#39;serve&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">.</span>argv<span class="token operator">=</span>global<span class="token punctuation">.</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NON_COMPILATION_ARGS</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token operator">=&gt;</span>a<span class="token operator">===</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NON_COMPILATION_CMD</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./utils/prompt-command&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">NON_COMPILATION_CMD</span><span class="token punctuation">,</span><span class="token operator">...</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>_ARGS 的内容 init // 创建一份webpack配置文件 migrate // 进行webpack版本迁移 add // 往webpack配置文件中增加属性 remove // 删除属性 serve // 运行webpack-serve generate-loader // 生成loader代码<br> generate-plugin // 生成plugin代码 info 返回与本地环境相关的一些信息</p><p>命令行工具包yargs介绍</p><p>动态生成help 帮助信息</p><p>webpack-cli使用args分析 参数分组(config/config-args.js),将命令划分为9类</p><p>config options 配置相关的参数 文件名称，运行环境等 basic options 基础参数 entry设置，debug模式，watch，devtool设置等 module options 模块参数，给loader 设置扩展 output options 输出参数（输出路径，输出文件名称 advacnded options 高级用法，记录设置，缓存设置，监听频率，bail等 resloving options 解析参数 alias和解析文件后缀 设置 optmization options 优化参数 status options 统计参数 options 通用参数 帮助命令 版本信息等</p><p>webpack-cli 执行结果 webpack-cli 对配置文件和命令行参数进行转换最终生成配置选项参数options 最终会根据配置参数实例化webpack对象，然后执行构建流程 webpack本质 webpack可以将其理解是一种基于事件流的编程规范，一系列的插件运行 先看一段代码 核心对象Compiler继承Tapable class Compiler extends Tapable{ // } 核心对象Compilation集成Tapable{ // } Tapable是什么？ Tapable是一个类似于Node.js的EventEmitter的库,主要是控制钩子的发布与订阅，控制这个webpack的插件系统 Tapable库暴露了很多Hooks ...</p><h4 id="模拟compiler-js" tabindex="-1"><a class="header-anchor" href="#模拟compiler-js" aria-hidden="true">#</a> 模拟Compiler.js</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hoos<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token literal-property property">accelerate</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;newspped&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">brake</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">calculateRoutes</span><span class="token operator">:</span><span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;source&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;target&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;routesList&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">accerate</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">break</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calculateRoutes</span><span class="token punctuation">(</span><span class="token string">&#39;Async&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;hook&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;demo&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">accelerate</span><span class="token punctuation">(</span><span class="token parameter">speed</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">accelerate</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">brake</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">calculateRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>calculateRoutes<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">lerror</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>插件 my-plugins.js</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Compiler<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./Compiler&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">MyPlugin</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>brake<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;WarningLampPlugin&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;WarningLampPlugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>accelerate<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;LoggerPlugin&#39;</span><span class="token punctuation">,</span><span class="token parameter">newSpeed</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Accelerating to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newSpeed<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>calculateRoutes<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">&#39;calculateRoutes tapAsync&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span>target<span class="token punctuation">,</span>routesList</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">tapPromise to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>source<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>routesList<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>模拟插件执行</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> myPlugin <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">MyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> options<span class="token operator">=</span><span class="token punctuation">{</span><span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>myPlugin<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> compiler<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin<span class="token operator">===</span><span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="webppack-流程篇" tabindex="-1"><a class="header-anchor" href="#webppack-流程篇" aria-hidden="true">#</a> Webppack 流程篇</h4><p>webpack的编译都按照下面的钩子调用顺序执行 *entry-option -&gt; *run -&gt; *make -&gt; *before-resolve -&gt; *build-module -&gt; *normal-module-loader -&gt; *program -&gt; *seal -&gt; *emit</p><ol><li>初始化 option</li><li>开始编译</li><li>从entry开始递归的分析依赖，对每个依赖模块进行build</li><li>对模块位置进行解析</li><li>开始构建某个模块</li><li>将loader加载完成的module进行编译，生成AST树</li><li>遍历AST树，当遇到require等一些调用表达式时，收集依赖</li><li>所有依赖build完成，开始优化</li><li>输出到dist目录</li></ol><p>WebpackOptionsApply 将所有的配置options参数转换成 webpack内部插件 使用默认插件列表 举例:</p><ul><li>outpu.library-&gt;LibraryTemplatePlugin</li><li>externals-&gt;ExternalsPlugin</li><li>devtool-&gt;EvalDevtoolModulePlugin,SourceMapDevToolPlugin</li><li>AMDPlugin,CommonJsPlugin</li><li>RemoveEmptyChunksPlugin</li></ul><p>Compiler Hooks 流程相关：</p><ul><li>before-)run</li><li>before-/after-)compile</li><li>make</li><li>after-)emit</li><li>done 监听相关:</li><li>watch-run</li><li>watch-close</li></ul><p>Compilation Compiler调用Compilation生命周期方法</p><ul><li>addEntry -&gt; addModuleChain</li><li>finish(上报模块错误)</li><li>seal</li></ul><p>ModuleFactory</p><ul><li>NormalModuleFactory</li><li>ContextModuleFactory Module</li><li>NormalModule</li><li>ContextModule(./src/*)</li><li>ExternalModule(module.exports=jQuery)</li><li>DelegatedModule(manifest)</li></ul><p>NormalModule Build</p><ul><li>使用loader-runner运行loaders</li><li>通过Parse解析(内部是acron)</li><li>ParsePlugins添加依赖</li></ul><p>Compilation hooks 模块相关</p><ul><li>build-module</li><li>failed-module</li><li>succeed-module 优化相关：</li><li>after-)seal</li><li>optimize</li><li>optimize-modules(-basic/advanced)</li><li>after-optimize-modules</li><li>after-optimize-chunks</li><li>after-optimize-tree</li><li>optimize-chunk-modules(-basic/advanced)</li></ul><p>资源生成相关：</p><ul><li>module-asset</li><li>chunk-asset</li></ul><p>Chunk 生成算法</p><ol><li>webpack先将entry中对应的module都生成一个新的chunk</li><li>遍历module的依赖列表，将依赖的module也加入到chunk中</li><li>如果一个依赖module是动态引入的模块，那么就会根据这个module创建一个新的chunk，继续遍历依赖</li><li>重复上面的过程直至得到所有的chunks</li></ol><p>模块化：增加代码可读性和维护性 传统的网页开发转变成WebApps开发 代码复杂度在逐步增高 分离的JS文件/模块，便于后续代码的维护性 部署时希望把代码优化成几个HTTP请求</p><p>常见的集中模块化方式 ES module CJS AMD</p><p>AST 基础知识 抽象语法树(abstract syntax tree),或者语法树(syntax tree),是源代码的抽象语法结构的树状表现形式,这里特指编程语言的源代码，树上的每个节点都表示源代码中的一种结构</p><h4 id="复习一下webpack的模块机制" tabindex="-1"><a class="header-anchor" href="#复习一下webpack的模块机制" aria-hidden="true">#</a> 复习一下webpack的模块机制</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> installedModules<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">i</span><span class="token operator">:</span> moduleId<span class="token punctuation">,</span>
            <span class="token literal-property property">l</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>module<span class="token punctuation">,</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>__webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>
        module<span class="token punctuation">.</span>l<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token comment">/* 0 module */</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span>__webpack_exports__<span class="token punctuation">,</span>__webpack_require__</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/* 1 module */</span>

<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ul><li>打包出来的是一个 IIFE（匿名闭包)</li><li>modules 是一个数组，每一项是一个模块初始化函数</li><li>__webpack_require用来加载模块，返回module.exports</li><li>通过WEBPACK_REQUIRE_METHOD(0) 启动程序</li></ul><p>动手实现一个简易的webpack</p><ol><li>可以将ES6语法转换成ES5的语法 <ul><li>通过babylon 生成AST</li><li>通过babel-core将AST重新生成源码</li></ul></li><li>可以分析模块之间的依赖关系 <ul><li>通过babel-traverse 的 ImportDeclaration方法获取依赖属性</li></ul></li><li>生成的JS文件可以在浏览器中运行</li></ol><h3 id="_07-编写loader插件" tabindex="-1"><a class="header-anchor" href="#_07-编写loader插件" aria-hidden="true">#</a> 07 编写Loader插件</h3><p>定义: loader只是一个导出为函数的javascript模块 <code>module.exports=function(source){ return source}</code></p><p>多loader时的执行顺序 多个loader串行执行 顺序从后到前</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
<span class="token comment">//...</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">rules</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.less$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span><span class="token literal-property property">use</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&#39;style-loader&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;css-loader&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;less-loader&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>函数组合的两种情况 Unit中的pipline Compose（webpack采取的是这种 <code>compose=(f,g)=&gt;(...args)=&gt;f(g(...args));</code></p><p>通过一个例子验证 loader的执行顺序 a-loader.js export=function(source){console.log(&#39;loader a is executed&#39;); return source;} b-loader.js export=function(source){console.log(&#39;loader b is executed&#39;); return source;}</p><ol start="7"><li>loader-runner介绍 定义：loader-runner允许你在不安装webpack的情况下运行loaders 作用：</li></ol><ul><li>作为webpack的依赖，webpack中使用它执行loader</li><li>进行loader的开发和调试</li></ul><ol start="8"><li>loader-runner的使用</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>runLoaders<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;loader-runner&#39;</span><span class="token punctuation">;</span>
<span class="token function">runLoaders</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">resource</span><span class="token operator">:</span> <span class="token string">&#39;/abs/path/to/file.txt?query&#39;</span><span class="token punctuation">,</span> <span class="token comment">// String: 资源的绝对路径 可加query</span>
    <span class="token literal-property property">loaders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;/abs/path/to/loader.js?query&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">// String[]:loader的绝对路径 可加query</span>
    <span class="token literal-property property">context</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">minimize</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 基础上下文之外额外的loader上下文</span>
    <span class="token literal-property property">readResource</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span><span class="token comment">// 读取资源的函数</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// error: Error?</span>
    <span class="token comment">// result.result: Buffer|String</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="9"><li>开发一个raw-loader</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// src/raw-loader.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> json<span class="token operator">=</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\u2028</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">&#39;\\u2028&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\u2029</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">&#39;\\u2029&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 为了安全起见，ES模板字符串的问题</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export default </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>json<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// src/demo.txt</span>
foobar

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="10"><li>使用loader-runner调试loader run-loader.js</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> fs<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>runLoaders<span class="token punctuation">}</span><span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;loader-runner&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">runLoaders</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">resource</span><span class="token operator">:</span> <span class="token string">&#39;./demo.txt&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">loaders</span><span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;./loaders/raw-loader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">readResource</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span>err<span class="token operator">?</span>console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token operator">:</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>查看运行结果： node run-loader.js</p><ol start="11"><li>loader的参数获取 通过 loader-utils的getOptions方法获取</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> loaderUtils<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;loader-utils&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">=</span>loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="12"><li>loader的异常处理</li></ol><p>loader内置直接通过throw抛出 通过this.callback传递错误 <code>this.callback(error: Error|null,content: string|Buffer,sourceMap?:SourceMap,meta?: any);</code> 13. loader的异步处理 通过this.async 来返回一个异步函数</p><ul><li>第一个参数是Error，第二个参数是处理的结果</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">input</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> callback<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// No callback=&gt; return synchronous results</span>
    <span class="token comment">// if(callback) </span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>input<span class="token operator">+</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="13"><li>在loader中使用缓存 webpack中默认开启loader缓存</li></ol><ul><li>可以使用 this.cacheable(false) 关掉缓存 缓存条件: loader的结果在相同的输入下有确定的输出</li><li>有依赖的loader无法使用缓存</li></ul><ol start="14"><li>loader如何进行文件输出?</li></ol><p>通过this.emitFile进行写入</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> loaderUtils<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;loader-utils&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token function">funciton</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> url<span class="token operator">=</span>loaderUtils<span class="token punctuation">.</span><span class="token function">interpolateName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token string">&#39;[hash].[ext]&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>content<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> path<span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__webpack_public_path__+ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export default </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="实战开发一个自动合成雪碧图的loader" tabindex="-1"><a class="header-anchor" href="#实战开发一个自动合成雪碧图的loader" aria-hidden="true">#</a> 实战开发一个自动合成雪碧图的loader</h4><p>支持的语法:</p><ol><li><code>background: url(&#39;a.png?__sprite&#39;);</code></li><li><code>background: url(&#39;b.png?__sprite&#39;);</code> ---&gt; background: url(&#39;sprite.png&#39;); 准备知识: 如何将两张图片合成一张图片? 使用 spritesmith(https://www.npmjs.com/package/spritesmith)</li></ol><p>spritesmith使用示例</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> sprites<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&#39;./images/1.jpg&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;./images/2.jpg&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
Spritesmith<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">src</span><span class="token operator">:</span> sprites<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token function">handleResult</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// result.image;</span>
    <span class="token comment">// result.coordinates;</span>
    <span class="token comment">// result.properties;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="插件的运行环境" tabindex="-1"><a class="header-anchor" href="#插件的运行环境" aria-hidden="true">#</a> 插件的运行环境</h4><ol start="18"><li><p>插件没有像loader那样的独立运行环境 只能在webpack里面运行</p></li><li><p>插件的基本结构</p></li></ol><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/vue-press/assets/app.8af49527.js" defer></script>
  </body>
</html>
